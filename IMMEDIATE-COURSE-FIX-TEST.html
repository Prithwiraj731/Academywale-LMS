<!DOCTYPE html>
<html>
<head>
    <title>IMMEDIATE COURSE CREATION TEST</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #1877f2; text-align: center; margin-bottom: 30px; }
        .section { margin: 25px 0; padding: 20px; border-radius: 8px; }
        .error { background: #fee; border-left: 5px solid #dc3545; }
        .success { background: #efe; border-left: 5px solid #28a745; }
        .warning { background: #fff8e1; border-left: 5px solid #ff9800; }
        .info { background: #e3f2fd; border-left: 5px solid #2196f3; }
        button { background: #1877f2; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        button:hover { background: #166fe5; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .code { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; margin: 10px 0; white-space: pre-wrap; font-size: 14px; }
        .status { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: bold; margin: 5px; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß IMMEDIATE COURSE CREATION FIX TEST</h1>
        
        <div class="section info">
            <h3>üéØ Testing Your Deployed Backend</h3>
            <p><strong>Backend URL:</strong> https://academywale-lms.onrender.com</p>
            <div id="backendStatus" class="status loading">Checking...</div>
            <button onclick="checkBackendStatus()">Check Backend Status</button>
        </div>

        <div class="section warning">
            <h3>üîç Current Issue Diagnosis</h3>
            <button onclick="diagnoseIssue()">Diagnose Current Problem</button>
            <div id="diagnosisResults"></div>
        </div>

        <div class="section">
            <h3>üß™ Test Course Creation</h3>
            <button onclick="testCourseCreation()">Test Course Creation Endpoint</button>
            <button onclick="createTestCourse()" class="danger">Try Creating Test Course</button>
            <div id="courseTestResults"></div>
        </div>

        <div class="section">
            <h3>üìä Database Verification</h3>
            <button onclick="checkDatabase()">Check Existing Courses</button>
            <div id="databaseResults"></div>
        </div>

        <div class="section success">
            <h3>‚úÖ Fix Implementation Status</h3>
            <div id="fixStatus">
                <p><strong>‚úÖ Backend Code Fixed:</strong> server/app.js now has working course creation endpoint</p>
                <p><strong>‚úÖ Frontend Debugging Added:</strong> Enhanced error logging in AdminDashboard.jsx</p>
                <p><strong>‚è≥ Deployment Needed:</strong> Updated code needs to be deployed to Render</p>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://academywale-lms.onrender.com';

        async function checkBackendStatus() {
            const statusEl = document.getElementById('backendStatus');
            statusEl.textContent = 'Checking...';
            statusEl.className = 'status loading';

            try {
                const response = await fetch(BASE_URL + '/health');
                if (response.ok) {
                    const data = await response.json();
                    statusEl.textContent = '‚úÖ Backend Online';
                    statusEl.className = 'status online';
                } else {
                    statusEl.textContent = '‚ùå Backend Issues';
                    statusEl.className = 'status offline';
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Backend Offline';
                statusEl.className = 'status offline';
            }
        }

        async function diagnoseIssue() {
            const results = document.getElementById('diagnosisResults');
            results.innerHTML = '<p>üîç Diagnosing the course creation issue...</p>';

            try {
                // Test the specific endpoint that's failing
                const response = await fetch(BASE_URL + '/api/admin/courses/standalone', { 
                    method: 'OPTIONS' 
                });
                
                if (response.status === 404) {
                    results.innerHTML = `
                        <div class="code">‚ùå ISSUE CONFIRMED: 
/api/admin/courses/standalone endpoint does NOT exist on deployed backend

Status: 404 Not Found

ROOT CAUSE: Your deployed Render backend doesn't have the updated route.

SOLUTION: Deploy the fixed server/app.js file to Render</div>`;
                } else if (response.status === 200 || response.status === 405) {
                    results.innerHTML = `
                        <div class="code">‚úÖ ENDPOINT EXISTS: 
/api/admin/courses/standalone is available (Status: ${response.status})

This means the fix has been deployed successfully!</div>`;
                } else {
                    results.innerHTML = `
                        <div class="code">üî∂ ENDPOINT STATUS: ${response.status}
This indicates the endpoint exists but may have other issues.</div>`;
                }
            } catch (error) {
                results.innerHTML = `
                    <div class="code">‚ùå NETWORK ERROR: ${error.message}
Cannot reach the backend server.</div>`;
            }
        }

        async function testCourseCreation() {
            const results = document.getElementById('courseTestResults');
            results.innerHTML = '<p>üß™ Testing course creation endpoint...</p>';

            const endpoints = [
                '/api/admin/courses/standalone',
                '/api/admin/courses',
                '/api/admin/courses/new'
            ];

            let output = '';
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(BASE_URL + endpoint, { method: 'OPTIONS' });
                    const status = response.status;
                    
                    if (status === 404) {
                        output += `‚ùå ${endpoint} - NOT FOUND (404)\\n`;
                    } else if (status === 200 || status === 405) {
                        output += `‚úÖ ${endpoint} - EXISTS (${status})\\n`;
                    } else {
                        output += `üî∂ ${endpoint} - Status: ${status}\\n`;
                    }
                } catch (error) {
                    output += `‚ùå ${endpoint} - ERROR: ${error.message}\\n`;
                }
            }

            results.innerHTML = `<div class="code">${output}</div>`;
        }

        async function createTestCourse() {
            const results = document.getElementById('courseTestResults');
            results.innerHTML += '<p>üöÄ Attempting to create test course...</p>';

            try {
                const formData = new FormData();
                formData.append('subject', 'Test Subject - Fix Verification');
                formData.append('title', 'Test Course Title');
                formData.append('category', 'CA');
                formData.append('subcategory', 'Foundation');
                formData.append('paperId', '1');
                formData.append('paperName', 'Test Paper');
                formData.append('isStandalone', 'true');
                formData.append('description', 'Test course to verify the fix');
                formData.append('modeAttemptPricing', JSON.stringify([{
                    mode: 'Test Mode',
                    attempts: [{ attempt: 'Test Attempt', costPrice: 100, sellingPrice: 80 }]
                }]));

                console.log('Sending test course to:', BASE_URL + '/api/admin/courses/standalone');

                const response = await fetch(BASE_URL + '/api/admin/courses/standalone', {
                    method: 'POST',
                    body: formData
                });

                const responseText = await response.text();
                
                if (response.ok) {
                    results.innerHTML += `<div class="code">‚úÖ SUCCESS! Test course created successfully!
Status: ${response.status}
Response: ${responseText}

üéâ THE FIX IS WORKING!</div>`;
                } else if (response.status === 404) {
                    results.innerHTML += `<div class="code">‚ùå STILL FAILING: Endpoint not found (404)
This means the updated code hasn't been deployed to Render yet.

Response: ${responseText}

NEXT STEP: Deploy the fixed server/app.js to Render</div>`;
                } else {
                    results.innerHTML += `<div class="code">‚ö†Ô∏è ENDPOINT EXISTS BUT FAILED: Status ${response.status}
Response: ${responseText}

This means the endpoint exists but there might be other issues.</div>`;
                }
            } catch (error) {
                results.innerHTML += `<div class="code">‚ùå NETWORK ERROR: ${error.message}</div>`;
            }
        }

        async function checkDatabase() {
            const results = document.getElementById('databaseResults');
            results.innerHTML = '<p>üìä Checking database contents...</p>';

            try {
                const response = await fetch(BASE_URL + '/api/courses/all');
                if (response.ok) {
                    const data = await response.json();
                    const courseCount = data.courses ? data.courses.length : 0;
                    results.innerHTML = `<div class="code">‚úÖ Database Connection Working
Found ${courseCount} existing courses in database

${courseCount > 0 ? 'Sample course: ' + JSON.stringify(data.courses[0], null, 2) : 'No courses found yet'}</div>`;
                } else {
                    results.innerHTML = `<div class="code">‚ùå Database Check Failed: ${response.status}</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="code">‚ùå Database Error: ${error.message}</div>`;
            }
        }

        // Auto-run initial checks
        window.onload = () => {
            checkBackendStatus();
            setTimeout(diagnoseIssue, 1000);
        };
    </script>
</body>
</html>
