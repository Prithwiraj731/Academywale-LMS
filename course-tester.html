<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Display Tester</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .course-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    .course-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .course-details {
      padding: 15px;
    }
    .course-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .standalone-badge {
      background-color: #e6f7ff;
      color: #0066cc;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
      margin-bottom: 8px;
    }
    .faculty-name {
      font-size: 14px;
      color: #666;
    }
    .controls {
      margin-bottom: 20px;
    }
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 10px;
    }
    input, select {
      padding: 8px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>Course Display Tester</h1>
  
  <div class="controls">
    <h2>Test Course Fetching</h2>
    <div>
      <select id="categorySelect">
        <option value="CA">CA</option>
        <option value="CMA">CMA</option>
      </select>
      
      <select id="subcategorySelect">
        <option value="foundation">Foundation</option>
        <option value="inter">Inter</option>
        <option value="final">Final</option>
      </select>
      
      <input type="number" id="paperIdInput" placeholder="Paper ID" value="1">
      
      <button id="fetchCoursesBtn">Fetch Courses</button>
    </div>
    
    <h2>Test Standalone Course Creation</h2>
    <div>
      <input type="text" id="titleInput" placeholder="Title" value="Test Standalone Course">
      <input type="text" id="subjectInput" placeholder="Subject" value="Test Subject">
      <button id="createCourseBtn">Create Test Course</button>
    </div>
  </div>
  
  <div id="results">
    <h2>Results:</h2>
    <pre id="resultsJson"></pre>
  </div>
  
  <h2>Courses:</h2>
  <div id="coursesContainer" class="container">
    <!-- Courses will appear here -->
  </div>
  
  <script>
    const API_URL = 'http://localhost:5000';
    const resultsJson = document.getElementById('resultsJson');
    const coursesContainer = document.getElementById('coursesContainer');
    
    // Fetch courses
    document.getElementById('fetchCoursesBtn').addEventListener('click', async () => {
      const category = document.getElementById('categorySelect').value;
      const subcategory = document.getElementById('subcategorySelect').value;
      const paperId = document.getElementById('paperIdInput').value;
      
      try {
        resultsJson.textContent = 'Fetching courses...';
        
        const response = await fetch(`${API_URL}/api/courses/${category}/${subcategory}/${paperId}?includeStandalone=true`);
        const data = await response.json();
        
        // Display the raw JSON
        resultsJson.textContent = JSON.stringify(data, null, 2);
        
        // Display course cards
        displayCourses(data.courses || []);
      } catch (error) {
        resultsJson.textContent = `Error: ${error.message}`;
      }
    });
    
    // Create test standalone course
    document.getElementById('createCourseBtn').addEventListener('click', async () => {
      const title = document.getElementById('titleInput').value;
      const subject = document.getElementById('subjectInput').value;
      const category = document.getElementById('categorySelect').value;
      const subcategory = document.getElementById('subcategorySelect').value;
      const paperId = document.getElementById('paperIdInput').value;
      
      try {
        resultsJson.textContent = 'Creating test course...';
        
        const formData = new FormData();
        formData.append('title', title);
        formData.append('subject', subject);
        formData.append('category', category);
        formData.append('subcategory', subcategory);
        formData.append('paperId', paperId);
        formData.append('paperName', `${category} ${subcategory} Paper ${paperId}`);
        formData.append('isStandalone', 'true');
        
        // Add some dummy data for required fields
        formData.append('description', 'Test description');
        formData.append('noOfLecture', '10');
        formData.append('videoLanguage', 'Hindi');
        
        // Add a basic pricing structure
        formData.append('modeAttemptPricing', JSON.stringify([
          {
            mode: 'Live at Home',
            attempts: [
              { attempt: '1 View', costPrice: 999, sellingPrice: 799 }
            ]
          }
        ]));
        
        // Create a basic poster image
        const blob = await createTestImage();
        formData.append('poster', blob, 'test-poster.png');
        
        const response = await fetch(`${API_URL}/api/admin/courses/standalone`, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        resultsJson.textContent = JSON.stringify(data, null, 2);
        
        if (data.success) {
          alert('Course created successfully! Now try fetching courses to see it.');
        }
      } catch (error) {
        resultsJson.textContent = `Error: ${error.message}`;
      }
    });
    
    // Helper function to display courses as cards
    function displayCourses(courses) {
      coursesContainer.innerHTML = '';
      
      if (!courses || courses.length === 0) {
        coursesContainer.innerHTML = '<p>No courses found.</p>';
        return;
      }
      
      courses.forEach(course => {
        const card = document.createElement('div');
        card.className = 'course-card';
        
        // Get poster URL
        let posterUrl = course.posterUrl;
        if (posterUrl && posterUrl.startsWith('/uploads')) {
          posterUrl = `${API_URL}${posterUrl}`;
        } else if (!posterUrl || !posterUrl.startsWith('http')) {
          posterUrl = './logo.svg';
        }
        
        card.innerHTML = `
          <img src="${posterUrl}" alt="${course.subject}" class="course-image" onerror="this.src='./logo.svg'">
          <div class="course-details">
            <div class="course-title">${course.subject}</div>
            ${course.isStandalone 
              ? '<div class="standalone-badge">Standalone Course</div>'
              : `<div class="faculty-name">by ${course.facultyName || 'Unknown'}</div>`
            }
            <div>Category: ${course.category} ${course.subcategory}</div>
            <div>Paper ID: ${course.paperId}</div>
          </div>
        `;
        
        coursesContainer.appendChild(card);
      });
    }
    
    // Helper function to create a test image
    async function createTestImage() {
      const canvas = document.createElement('canvas');
      canvas.width = 400;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#f0f0f0';
      ctx.fillRect(0, 0, 400, 300);
      
      ctx.fillStyle = '#20b2aa';
      ctx.font = 'bold 24px Arial';
      ctx.fillText('Test Standalone Course', 50, 150);
      
      return new Promise(resolve => {
        canvas.toBlob(blob => {
          resolve(blob);
        }, 'image/png');
      });
    }
  </script>
</body>
</html>
